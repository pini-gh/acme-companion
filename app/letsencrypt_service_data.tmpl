#!/bin/bash
# shellcheck disable=SC2034
{{ $host_variable_name := coalesce $.Env.HOST_VARIABLE_NAME "LETSENCRYPT_HOST" }}
LETSENCRYPT_CONTAINERS=(
{{ $orderedContainers := sortObjectsByKeysDesc $ "Created" }}
{{ range $_, $container := whereExist $orderedContainers (printf "Env.%s" $host_variable_name) }}
    {{ if trim $container.Env.LETSENCRYPT_HOST }}
        {{ if parseBool (coalesce $container.Env.LETSENCRYPT_SINGLE_DOMAIN_CERTS "false") }}
            {{/* Explicit per-domain splitting of the certificate */}}
            {{ range $host := split $container.Env.LETSENCRYPT_HOST "," }}
                {{ $host := trim $host }}
{{- "\n    " }}'{{ printf "%.12s" $container.ID }}_{{ sha1 $host }}' # {{ $container.Name }}, created at {{ $container.Created }}
            {{ end }}
        {{ else }}
            {{/* Default: multi-domain (SAN) certificate */}}
{{- "\n    " }}'{{ printf "%.12s" $container.ID }}' # {{ $container.Name }}, created at {{ $container.Created }}
        {{ end }}
    {{ end }}
{{ end }}
)

{{ range $hosts, $containers := groupBy $ (printf "Env.%s" $host_variable_name) }}
    {{ $hosts := trimSuffix "," $hosts }}
    {{ range $container := $containers }}
        {{/* Trim spaces and set empty values on per-container environment variables */}}
        {{ $KEYSIZE := trim (coalesce $container.Env.LETSENCRYPT_KEYSIZE "") }}
        {{ $STAGING := trim (coalesce $container.Env.LETSENCRYPT_TEST "") }}
        {{ $EMAIL := trim (coalesce $container.Env.LETSENCRYPT_EMAIL "") }}
        {{ $CA_URI := trim (coalesce $container.Env.ACME_CA_URI "") }}
        {{ $PREFERRED_CHAIN := trim (coalesce $container.Env.ACME_PREFERRED_CHAIN "") }}
        {{ $OCSP := trim (coalesce $container.Env.ACME_OCSP "") }}
        {{ $EAB_KID := trim (coalesce $container.Env.ACME_EAB_KID "") }}
        {{ $EAB_HMAC_KEY := trim (coalesce $container.Env.ACME_EAB_HMAC_KEY "") }}
        {{ $ZEROSSL_API_KEY := trim (coalesce $container.Env.ZEROSSL_API_KEY "") }}
        {{ $RESTART_CONTAINER := trim (coalesce $container.Env.LETSENCRYPT_RESTART_CONTAINER "") }}
        {{ $PRE_HOOK := trim (coalesce $container.Env.ACME_PRE_HOOK "") }}
        {{ $POST_HOOK := trim (coalesce $container.Env.ACME_POST_HOOK "") }}
        {{ $DNS_MODE_SETTINGS := trim (coalesce $container.Env.LETSENCRYPT_DNS_MODE_SETTINGS "") }}
        {{ $DNS_MODE := coalesce $container.Env.LETSENCRYPT_DNS_MODE "" | trimSuffix "," | trim }}
        {{ $DNS_CHALLENGE_ALIAS := coalesce $container.Env.LETSENCRYPT_DNS_CHALLENGE_ALIAS "" | trimSuffix "," | trim }}
        {{ $dnsModes := split $DNS_MODE "," }}
        {{ $dnsChallengeAliases := split $DNS_CHALLENGE_ALIAS "," }}
        {{ $cid := printf "%.12s" $container.ID }}
        {{- "\n" }}# Container {{ $cid }} ({{ $container.Name }})
        {{ if parseBool (coalesce $container.Env.LETSENCRYPT_SINGLE_DOMAIN_CERTS "false") }}
            {{/* Explicit per-domain splitting of the certificate */}}
            {{ range $hostsIndex, $host := split $hosts "," }}
                {{ $host := trim $host }}
                {{ $host := trimSuffix "." $host }}
                {{ $hostHash := sha1 $host }}
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_HOST=('{{ $host }}')
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_KEYSIZE="{{ $KEYSIZE }}"
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_TEST="{{ $STAGING }}"
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_EMAIL="{{ $EMAIL }}"
                {{- "\n" }}ACME_{{ $cid }}_{{ $hostHash }}_CA_URI="{{ $CA_URI }}"
                {{- "\n" }}ACME_{{ $cid }}_{{ $hostHash }}_PREFERRED_CHAIN="{{ $PREFERRED_CHAIN }}"
                {{- "\n" }}ACME_{{ $cid }}_{{ $hostHash }}_OCSP="{{ $OCSP }}"
                {{- "\n" }}ACME_{{ $cid }}_{{ $hostHash }}_EAB_KID="{{ $EAB_KID }}"
                {{- "\n" }}ACME_{{ $cid }}_{{ $hostHash }}_EAB_HMAC_KEY="{{ $EAB_HMAC_KEY }}"
                {{- "\n" }}ZEROSSL_{{ $cid }}_{{ $hostHash }}_API_KEY="{{ $ZEROSSL_API_KEY }}"
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_RESTART_CONTAINER="{{ $RESTART_CONTAINER }}"
                {{- "\n" }}ACME_{{ $cid }}_{{ $hostHash }}_PRE_HOOK="{{ $PRE_HOOK }}"
                {{- "\n" }}ACME_{{ $cid }}_{{ $hostHash }}_POST_HOOK="{{ $POST_HOOK }}"
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_DNS_MODE_SETTINGS="{{ $DNS_MODE_SETTINGS }}"
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_DNS_MODE=(
                        {{ if ne $DNS_MODE "" }}
                            {{- if lt $hostsIndex (len $dnsModes) -}}
                                {{ $dnsMode := index $dnsModes $hostsIndex | trim | trimSuffix "." }}
                                {{- if ne $dnsMode "" -}}
                                    '{{ $dnsMode }}'
                                {{- end -}}
                            {{- else -}}
                                {{ $firstDnsMode := index $dnsModes 0 | trim | trimSuffix "." }}
                                {{- if ne $firstDnsMode "" -}}
                                    '{{ $firstDnsMode }}'
                                {{- end -}}
                            {{- end -}}
                        {{- end -}}
                )
                {{- "\n" }}LETSENCRYPT_{{ $cid }}_{{ $hostHash }}_DNS_CHALLENGE_ALIAS=(
                        {{ if ne $DNS_CHALLENGE_ALIAS "" }}
                            {{- if lt $hostsIndex (len $dnsChallengeAliases) -}}
                                {{ $dnsChallengeAlias := index $dnsChallengeAliases $hostsIndex | trim | trimSuffix "." }}
                                {{- if and (ne $dnsChallengeAlias "") (ne $dnsChallengeAlias "no") -}}
                                    '{{ $dnsChallengeAlias }}'
                                {{- end -}}
                            {{- else -}}
                                {{ $firstDnsChallengeAlias := index $dnsChallengeAliases 0 | trim | trimSuffix "." }}
                                {{- if and (ne $firstDnsChallengeAlias "") (ne $firstDnsChallengeAlias "no") -}}
                                    '{{ $firstDnsChallengeAlias }}'
                                {{- end -}}
                            {{- end -}}
                        {{- end -}}
                )
            {{ end }}
        {{ else }}
            {{/* Default: multi-domain (SAN) certificate */}}
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_HOST=( 
                    {{- range $host := split $hosts "," }}
                        {{- $host := trim $host }}
                        {{- $host := trimSuffix "." $host -}}
                        '{{ $host }}'{{ " " }} 
                    {{- end -}}
            )
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_KEYSIZE="{{ $KEYSIZE }}"
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_TEST="{{ $STAGING }}"
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_EMAIL="{{ $EMAIL }}"
            {{- "\n" }}ACME_{{ $cid }}_CA_URI="{{ $CA_URI }}"
            {{- "\n" }}ACME_{{ $cid }}_PREFERRED_CHAIN="{{ $PREFERRED_CHAIN }}"
            {{- "\n" }}ACME_{{ $cid }}_OCSP="{{ $OCSP }}"
            {{- "\n" }}ACME_{{ $cid }}_EAB_KID="{{ $EAB_KID }}"
            {{- "\n" }}ACME_{{ $cid }}_EAB_HMAC_KEY="{{ $EAB_HMAC_KEY }}"
            {{- "\n" }}ZEROSSL_{{ $cid }}_API_KEY="{{ $ZEROSSL_API_KEY }}"
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_RESTART_CONTAINER="{{ $RESTART_CONTAINER }}"
            {{- "\n" }}ACME_{{ $cid }}_PRE_HOOK="{{ $PRE_HOOK }}"
            {{- "\n" }}ACME_{{ $cid }}_POST_HOOK="{{ $POST_HOOK }}"
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_DNS_MODE_SETTINGS="{{ $DNS_MODE_SETTINGS }}"
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_DNS_MODE=(
                    {{ if ne $DNS_MODE "" }}
                        {{- range $dnsMode := $dnsModes -}}
                            '{{ $dnsMode | trim | trimSuffix "." }}'{{ " " }} 
                        {{- end -}}
                    {{- end -}}
            )
            {{- "\n" }}LETSENCRYPT_{{ $cid }}_DNS_CHALLENGE_ALIAS=(
                    {{ if ne $DNS_CHALLENGE_ALIAS "" }}
                        {{- range $dnsChallengeAlias := $dnsChallengeAliases -}}
                            '{{ $dnsChallengeAlias | trim | trimSuffix "." }}'{{ " " }} 
                        {{- end -}}
                    {{- end -}}
            )
        {{ end }}
    {{ end }}
{{ end }}
